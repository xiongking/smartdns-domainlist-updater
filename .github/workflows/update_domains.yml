name: Update SmartDNS Domain Lists

on:
  # 设置定时任务：每6小时运行一次
  schedule:
    # '0 */6 * * *' 表示在每小时的第0分钟，每隔6小时运行一次 (例如 00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *' 
  # 允许手动触发
  workflow_dispatch:

jobs:
  update-list:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with Write Permission
        uses: actions/checkout@v4
        with:
          # 必须拉取完整历史记录
          fetch-depth: 0
          # 【修正 1】：使用具有写入权限的 REPO_TOKEN 进行 Checkout
          token: ${{ secrets.REPO_TOKEN }}
          
      - name: Download and Process oversea_domainlist
        run: |
          # 下载文件
          curl -sS "https://raw.githubusercontent.com/hezhijie0327/GFWList2AGH/main/gfwlist2smartdns/blacklist_full.conf" -o blacklist_full.conf
          
          # 处理内容：将 'nameserver /domain/foreign' 格式修改为 'domain'
          sed -E 's/nameserver \/(.*)\/foreign/\1/g' blacklist_full.conf > oversea_domainlist.conf
          
          # 清理临时文件
          rm blacklist_full.conf
          
      - name: Download and Process domestic_domainlist
        run: |
          # 下载文件
          curl -sS "https://raw.githubusercontent.com/hezhijie0327/GFWList2AGH/main/gfwlist2smartdns/whitelist_full.conf" -o whitelist_full.conf
          
          # 处理内容：将 'nameserver /domain/domestic' 格式修改为 'domain'
          sed -E 's/nameserver \/(.*)\/domestic/\1/g' whitelist_full.conf > domestic_domainlist.conf
          
          # 清理临时文件
          rm whitelist_full.conf

      # 【修正 2】：使用专用的 Action 处理提交和推送
      - name: Commit and Push changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: GitHub Action
          author_email: action@github.com
          message: 'Auto update domain lists (via GitHub Actions)'
          # 只提交生成的两个文件
          add: 'oversea_domainlist.conf domestic_domainlist.conf'
          # 使用 REPO_TOKEN 进行认证
          token: ${{ secrets.REPO_TOKEN }}
